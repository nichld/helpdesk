<div class="ticket-container">
  <!-- Back button -->
  <div class="ticket-header mb-4">
    <div class="flex justify-between items-center">
      <a href="/admin/tickets" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to tickets
      </a>
      
      <!-- Status badge moved to right -->
      <div>
        <% if (ticket.status === 'open') { %>
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
            Open
          </span>
        <% } else if (ticket.status === 'in-progress') { %>
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
            In Progress
          </span>
        <% } else if (ticket.status === 'solved') { %>
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
            Solved
          </span>
        <% } else if (ticket.status === 'closed') { %>
          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-800 text-white">
            Closed
          </span>
        <% } %>
      </div>
    </div>
  </div>
  
  <!-- Combined ticket metadata and actions section -->
  <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <h1 class="text-2xl font-bold text-gray-900"><%= ticket.title %></h1>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left column with ticket details -->
      <div class="grid grid-cols-2 gap-y-4 gap-x-8">
        <!-- Description - now part of the grid -->
        <div class="col-span-2 mb-4">
          <p class="text-xs text-gray-500 mb-1">Description</p>
          <p class="font-medium text-gray-700 whitespace-pre-wrap">
            <% if (ticket.description && ticket.description.trim()) { %>
              <%= ticket.description %>
            <% } else { %>
              <span class="text-gray-400 italic">No description provided</span>
            <% } %>
          </p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Category</p>
          <p class="font-medium"><%= ticket.category %></p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Priority</p>
          <p class="font-medium">
            <% if (!ticket.priority) { %>
              N/A
            <% } else if (ticket.priority === 'low') { %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Low</span>
            <% } else if (ticket.priority === 'medium') { %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Medium</span>
            <% } else if (ticket.priority === 'high') { %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">High</span>
            <% } else if (ticket.priority === 'critical') { %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Critical</span>
            <% } %>
          </p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Assigned To</p>
          <p class="font-medium">
            <% if (ticket.assignedTo) { %>
              <%= ticket.assignedTo.firstName %> <%= ticket.assignedTo.lastName %>
            <% } else { %>
              N/A
            <% } %>
          </p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Customer</p>
          <p class="font-medium"><%= ticket.customer.firstName %> <%= ticket.customer.lastName %></p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Created</p>
          <p class="font-medium"><%= new Date(ticket.createdAt).toLocaleDateString() %></p>
        </div>
        
        <div>
          <p class="text-xs text-gray-500">Last Activity</p>
          <p class="font-medium"><%= new Date(ticket.lastActivity).toLocaleString() %></p>
        </div>
      </div>
    
      <!-- Right column with employee actions - Now using standard forms -->
      <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h3 class="font-medium text-gray-700 mb-3">Ticket Actions</h3>
        
        <!-- Update ticket properties form -->
        <form action="/admin/tickets/<%= ticket._id %>/update" method="POST" class="space-y-4">
          <!-- Status selection -->
          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="status" name="status" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>Open</option>
              <option value="in-progress" <%= ticket.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
              <option value="solved" <%= ticket.status === 'solved' ? 'selected' : '' %>>Solved</option>
              <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>Closed</option>
            </select>
          </div>
          
          <!-- Priority selection -->
          <div>
            <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
            <select id="priority" name="priority" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Not set</option>
              <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>>Low</option>
              <option value="medium" <%= ticket.priority === 'medium' ? 'selected' : '' %>>Medium</option>
              <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>>High</option>
              <option value="critical" <%= ticket.priority === 'critical' ? 'selected' : '' %>>Critical</option>
            </select>
          </div>
          
          <!-- Category selection -->
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select id="category" name="category" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="general" <%= ticket.category === 'general' ? 'selected' : '' %>>General</option>
              <option value="technical" <%= ticket.category === 'technical' ? 'selected' : '' %>>Technical</option>
              <option value="billing" <%= ticket.category === 'billing' ? 'selected' : '' %>>Billing</option>
              <option value="feature" <%= ticket.category === 'feature' ? 'selected' : '' %>>Feature Request</option>
              <option value="bug" <%= ticket.category === 'bug' ? 'selected' : '' %>>Bug Report</option>
            </select>
          </div>
          
          <!-- Update ticket button -->
          <button 
            type="submit" 
            class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
          >
            Save Changes
          </button>
        </form>
        
        <!-- Assignment options - separate forms for different actions -->
        <div class="mt-4">
          <label class="block text-sm text-gray-600 mb-1">Assign to</label>
          <div class="space-y-2">
            <% if (!ticket.assignedTo || ticket.assignedTo._id.toString() !== user.id) { %>
              <form action="/admin/tickets/<%= ticket._id %>/assign-to-me" method="POST">
                <button 
                  type="submit" 
                  class="w-full flex items-center justify-center px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150"
                >
                  Assign to me
                </button>
              </form>
            <% } %>
            
            <% if (ticket.assignedTo) { %>
              <form action="/admin/tickets/<%= ticket._id %>/unassign" method="POST">
                <button 
                  type="submit" 
                  class="w-full flex items-center justify-center px-3 py-2 bg-gray-50 text-gray-700 border border-gray-200 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150"
                >
                  Unassign ticket
                </button>
              </form>
            <% } %>
          </div>
        </div>
        
        <!-- Delete ticket option (admin only) -->
        <% if (locals.isAdmin && (ticket.status === 'solved' || ticket.status === 'closed')) { %>
          <div class="mt-4">
            <form action="/admin/tickets/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this ticket? This action cannot be undone and will delete all associated messages.');">
              <input type="hidden" name="ticketId" value="<%= ticket._id %>">
              <button 
                type="submit" 
                class="w-full flex items-center justify-center px-3 py-2 border border-red-300 rounded-md text-sm font-medium bg-red-50 text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete Ticket
              </button>
            </form>
          </div>
        <% } %>
        
        <% if (success) { %>
          <div class="mt-3 text-sm text-green-600">
            <%= success %>
          </div>
        <% } %>
        
        <% if (error) { %>
          <div class="mt-3 text-sm text-red-600">
            <%= error %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
  
  <!-- Messages section -->
  <div class="bg-white border border-gray-200 rounded-lg mb-6">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold">Messages</h2>
        <a href="/admin/tickets/<%= ticket._id %>/messages" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center transition duration-150"
           target="_blank">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
          </svg>
          View Messages
        </a>
      </div>
    </div>
    <div class="p-6">
      <% if (messages && messages.length > 0) { %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <p class="text-sm text-gray-500 mb-1">Last activity</p>
            <p class="text-gray-700"><%= new Date(ticket.lastActivity).toLocaleString() %></p>
          </div>
          <div>
            <p class="text-sm text-gray-500 mb-1">Total messages</p>
            <p class="text-gray-700"><%= messages.length %></p>
          </div>
        </div>
        
        <!-- Latest 2 messages preview -->
        <div class="border-t pt-4 mt-4">
          <p class="text-sm text-gray-500 mb-2">Latest messages</p>
          
          <% const latestMessages = messages.slice(-2).reverse(); %>
          <% latestMessages.forEach((message, index) => { %>
            <div class="flex items-start gap-3 <%= index === 0 ? '' : 'mt-4 pt-4 border-t' %>">
              <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden bg-gray-200">
                <% if (message.sender.profileImage) { %>
                  <img src="<%= message.sender.profileImage %>" alt="Avatar" class="w-full h-full object-cover">
                <% } else { %>
                  <div class="w-full h-full flex items-center justify-center text-sm font-medium text-gray-500">
                    <%= message.sender.firstName.charAt(0).toUpperCase() %>
                  </div>
                <% } %>
              </div>
              
              <div class="flex-1">
                <div class="flex items-center mb-1">
                  <p class="text-sm font-medium text-gray-900">
                    <%= message.sender.firstName %> <%= message.sender.lastName %>
                  </p>
                  <% if (message.sender.role === 'customer') { %>
                    <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Customer</span>
                  <% } %>
                  <span class="ml-auto text-xs text-gray-500">
                    <%= new Date(message.createdAt).toLocaleString() %>
                  </span>
                </div>
                
                <% if (message.contentType === 'text') { %>
                  <p class="text-gray-700 text-sm">
                    <%= message.content.length > 100 
                        ? message.content.substring(0, 100) + '...' 
                        : message.content %>
                  </p>
                <% } else if (message.contentType === 'image') { %>
                  <p class="text-gray-700 text-sm italic">
                    [Image attachment]
                  </p>
                <% } %>
              </div>
            </div>
          <% }); %>
          
          <% if (messages.length > 2) { %>
            <div class="mt-4 text-center">
              <a href="/admin/tickets/<%= ticket._id %>/messages" class="text-blue-600 hover:text-blue-800 text-sm">
                View all <%= messages.length %> messages â†’
              </a>
            </div>
          <% } %>
        </div>
      <% } else { %>
        <div class="text-center py-6">
          <p class="text-gray-500">No messages yet.</p>
          <a href="/admin/tickets/<%= ticket._id %>/messages" class="mt-2 inline-block text-blue-600 hover:text-blue-800">
            Start a conversation
          </a>
        </div>
      <% } %>
    </div>
  </div>
</div>